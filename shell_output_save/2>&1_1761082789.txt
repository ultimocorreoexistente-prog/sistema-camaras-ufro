=== LIMPIANDO BASE DE DATOS RAILWAY ===

⚠️  ADVERTENCIA: Se eliminarán TODOS los datos de las tablas

Eliminando datos de las tablas...

   ✓ Tabla 'falla' limpiada
   ✓ Tabla 'mantenimiento' limpiada
   ✓ Tabla 'camara' limpiada
   ✓ Tabla 'puerto_switch' limpiada
   ✓ Tabla 'switch' limpiada
   ✓ Tabla 'nvr_dvr' limpiada
   ✓ Tabla 'fuente_poder' limpiada
   ✓ Tabla 'ups' limpiada
   ✓ Tabla 'gabinete' limpiada
   ✓ Tabla 'catalogo_tipo_falla' limpiada
   ✓ Tabla 'equipo_tecnico' limpiada
   ✓ Tabla 'ubicacion' limpiada
   ✓ Tabla 'usuario' limpiada

✅ Base de datos limpiada exitosamente
   → Todas las tablas están vacías y listas para la migración

=== INICIANDO MIGRACIÓN ===
Creando usuarios por defecto...

✓ Usuarios creados

=== INICIANDO MIGRACIÓN DE DATOS ===

1. Migrando Ubicaciones...
   ✓ 8 ubicaciones insertadas

2. Migrando Equipos Técnicos...
   ✓ 2 equipos técnicos insertados (2 con nombres auto-generados, 4 filas omitidas)

3. Migrando Catálogo de Tipos de Fallas...
   ✓ 0 tipos de fallas insertados (17 filas omitidas)

4. Migrando Gabinetes...
   ✓ 0 gabinetes insertados (6 filas omitidas)

5. Migrando Switches...
   ✓ 3 switches insertados (3 con códigos auto-generados, 3 filas omitidas)

6. Migrando Puertos de Switch...
   ✓ 0 puertos de switch insertados (6 filas omitidas)

7. Migrando UPS...
   ✓ 5 UPS insertados (5 con códigos auto-generados, 0 filas omitidas)

8. Migrando NVR/DVR...
   ✓ 6 NVR/DVR insertados (6 con códigos auto-generados, 0 filas omitidas)

9. Migrando Fuentes de Poder...
   ✓ 6 fuentes de poder insertadas (6 con códigos auto-generados, 0 filas omitidas)

10. Migrando Cámaras...
   ✓ 0 cámaras insertadas (467 filas omitidas)

11. Migrando Fallas (con validación anti-duplicados)...
   ✓ 0 fallas insertadas (0 rechazadas por duplicado)

12. Migrando Mantenimientos...
   ⚠ Error procesando Mantenimientos.xlsx: (psycopg2.errors.NotNullViolation) null value in column "equipo_id" of relation "mantenimiento" violates not-null constraint
DETAIL:  Failing row contains (7, Camara, null, null, 2025-10-22 05:39:48.110861, 38, null, null, null, null, null, Mantenimiento exitoso, sistema operando normalmente).

[SQL: INSERT INTO mantenimiento (equipo_tipo, equipo_id, tipo, fecha, tecnico_id, descripcion, materiales_utilizados, equipos_afectados, tiempo_ejecucion_horas, costo, observaciones) SELECT p0::VARCHAR, p1::INTEGER, p2::VARCHAR, p3::TIMESTAMP WITHOUT TIME  ... 1529 characters truncated ... p8, p9, p10, sen_counter) ORDER BY sen_counter RETURNING mantenimiento.id, mantenimiento.id AS id__1]
[parameters: {'equipo_id__0': None, 'tecnico_id__0': 38, 'tiempo_ejecucion_horas__0': None, 'observaciones__0': 'Mantenimiento exitoso, sistema operando normalmente', 'costo__0': None, 'tipo__0': None, 'materiales_utilizados__0': None, 'equipo_tipo__0': 'Camara', 'descripcion__0': None, 'equipos_afectados__0': None, 'fecha__0': datetime.datetime(2025, 10, 22, 5, 39, 48, 110861), 'equipo_id__1': None, 'tecnico_id__1': 38, 'tiempo_ejecucion_horas__1': None, 'observaciones__1': 'Mantenimiento trimestral programado', 'costo__1': None, 'tipo__1': 'Preventivo', 'materiales_utilizados__1': None, 'equipo_tipo__1': 'Camara', 'descripcion__1': None, 'equipos_afectados__1': None, 'fecha__1': datetime.datetime(2025, 10, 22, 5, 39, 48, 119683), 'equipo_id__2': None, 'tecnico_id__2': 38, 'tiempo_ejecucion_horas__2': None, 'observaciones__2': 'Switch presentaba sobrecalentamiento', 'costo__2': None, 'tipo__2': 'Correctivo', 'materiales_utilizados__2': None, 'equipo_tipo__2': 'Camara', 'descripcion__2': None, 'equipos_afectados__2': None, 'fecha__2': datetime.datetime(2025, 10, 22, 5, 39, 48, 119825), 'equipo_id__3': None, 'tecnico_id__3': 38, 'tiempo_ejecucion_horas__3': None, 'observaciones__3': 'RAID 1 operando correctamente', 'costo__3': None, 'tipo__3': 'Preventivo', 'materiales_utilizados__3': None, 'equipo_tipo__3': 'Camara', 'descripcion__3': None, 'equipos_afectados__3': None, 'fecha__3': datetime.datetime(2025, 10, 22, 5, 39, 48, 119946), 'equipo_id__4': None, 'tecnico_id__4': 38, 'tiempo_ejecucion_horas__4': None, 'observaciones__4': 'Fuente presentó falla total - reemplazada', 'costo__4': None, 'tipo__4': 'Correctivo', 'materiales_utilizados__4': None, 'equipo_tipo__4': 'Camara', 'descripcion__4': None, 'equipos_afectados__4': None, 'fecha__4': datetime.datetime(2025, 10, 22, 5, 39, 48, 120060), 'equipo_id__5': None, 'tecnico_id__5': 38, 'tiempo_ejecucion_horas__5': None, 'observaciones__5': 'Baterías con 1 año de uso - cambio preventivo', 'costo__5': None, 'tipo__5': 'Preventivo', 'materiales_utilizados__5': None, 'equipo_tipo__5': 'Camara', 'descripcion__5': None, 'equipos_afectados__5': None, 'fecha__5': datetime.datetime(2025, 10, 22, 5, 39, 48, 120194)}]
(Background on this error at: https://sqlalche.me/e/20/gkpj)

=== MIGRACIÓN COMPLETADA EXITOSAMENTE ===

=== RESUMEN DE DATOS ===

⚠⚠⚠ ERROR EN MIGRACIÓN: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.NotNullViolation) null value in column "equipo_id" of relation "mantenimiento" violates not-null constraint
DETAIL:  Failing row contains (7, Camara, null, null, 2025-10-22 05:39:48.110861, 38, null, null, null, null, null, Mantenimiento exitoso, sistema operando normalmente).

[SQL: INSERT INTO mantenimiento (equipo_tipo, equipo_id, tipo, fecha, tecnico_id, descripcion, materiales_utilizados, equipos_afectados, tiempo_ejecucion_horas, costo, observaciones) SELECT p0::VARCHAR, p1::INTEGER, p2::VARCHAR, p3::TIMESTAMP WITHOUT TIME  ... 1529 characters truncated ... p8, p9, p10, sen_counter) ORDER BY sen_counter RETURNING mantenimiento.id, mantenimiento.id AS id__1]
[parameters: {'equipo_id__0': None, 'tecnico_id__0': 38, 'tiempo_ejecucion_horas__0': None, 'observaciones__0': 'Mantenimiento exitoso, sistema operando normalmente', 'costo__0': None, 'tipo__0': None, 'materiales_utilizados__0': None, 'equipo_tipo__0': 'Camara', 'descripcion__0': None, 'equipos_afectados__0': None, 'fecha__0': datetime.datetime(2025, 10, 22, 5, 39, 48, 110861), 'equipo_id__1': None, 'tecnico_id__1': 38, 'tiempo_ejecucion_horas__1': None, 'observaciones__1': 'Mantenimiento trimestral programado', 'costo__1': None, 'tipo__1': 'Preventivo', 'materiales_utilizados__1': None, 'equipo_tipo__1': 'Camara', 'descripcion__1': None, 'equipos_afectados__1': None, 'fecha__1': datetime.datetime(2025, 10, 22, 5, 39, 48, 119683), 'equipo_id__2': None, 'tecnico_id__2': 38, 'tiempo_ejecucion_horas__2': None, 'observaciones__2': 'Switch presentaba sobrecalentamiento', 'costo__2': None, 'tipo__2': 'Correctivo', 'materiales_utilizados__2': None, 'equipo_tipo__2': 'Camara', 'descripcion__2': None, 'equipos_afectados__2': None, 'fecha__2': datetime.datetime(2025, 10, 22, 5, 39, 48, 119825), 'equipo_id__3': None, 'tecnico_id__3': 38, 'tiempo_ejecucion_horas__3': None, 'observaciones__3': 'RAID 1 operando correctamente', 'costo__3': None, 'tipo__3': 'Preventivo', 'materiales_utilizados__3': None, 'equipo_tipo__3': 'Camara', 'descripcion__3': None, 'equipos_afectados__3': None, 'fecha__3': datetime.datetime(2025, 10, 22, 5, 39, 48, 119946), 'equipo_id__4': None, 'tecnico_id__4': 38, 'tiempo_ejecucion_horas__4': None, 'observaciones__4': 'Fuente presentó falla total - reemplazada', 'costo__4': None, 'tipo__4': 'Correctivo', 'materiales_utilizados__4': None, 'equipo_tipo__4': 'Camara', 'descripcion__4': None, 'equipos_afectados__4': None, 'fecha__4': datetime.datetime(2025, 10, 22, 5, 39, 48, 120060), 'equipo_id__5': None, 'tecnico_id__5': 38, 'tiempo_ejecucion_horas__5': None, 'observaciones__5': 'Baterías con 1 año de uso - cambio preventivo', 'costo__5': None, 'tipo__5': 'Preventivo', 'materiales_utilizados__5': None, 'equipo_tipo__5': 'Camara', 'descripcion__5': None, 'equipos_afectados__5': None, 'fecha__5': datetime.datetime(2025, 10, 22, 5, 39, 48, 120194)}]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
Traceback (most recent call last):
  File "/workspace/sistema-camaras-flask/migrate_data.py", line 649, in <module>
    migrar_datos()
  File "/workspace/sistema-camaras-flask/migrate_data.py", line 609, in migrar_datos
    print(f"Ubicaciones: {Ubicacion.query.count()}")
                          ^^^^^^^^^^^^^^^^^^^^^^^
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py", line 3146, in count
    self._legacy_from_self(col).enable_eagerloads(False).scalar()
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py", line 2835, in scalar
    ret = self.one()
          ^^^^^^^^^^
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py", line 2808, in one
    return self._iter().one()  # type: ignore
           ^^^^^^^^^^^^
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/query.py", line 2857, in _iter
    result: Union[ScalarResult[_T], Result[_T]] = self.session.execute(
                                                  ^^^^^^^^^^^^^^^^^^^^^
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2239, in _execute_internal
    conn = self._connection_for_bind(bind)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2108, in _connection_for_bind
    return trans._connection_for_bind(engine, execution_options)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 2, in _connection_for_bind
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
    self._raise_for_prerequisite_state(fn.__name__, current_state)
  File "/tmp/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 971, in _raise_for_prerequisite_state
    raise sa_exc.PendingRollbackError(
sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: (psycopg2.errors.NotNullViolation) null value in column "equipo_id" of relation "mantenimiento" violates not-null constraint
DETAIL:  Failing row contains (7, Camara, null, null, 2025-10-22 05:39:48.110861, 38, null, null, null, null, null, Mantenimiento exitoso, sistema operando normalmente).

[SQL: INSERT INTO mantenimiento (equipo_tipo, equipo_id, tipo, fecha, tecnico_id, descripcion, materiales_utilizados, equipos_afectados, tiempo_ejecucion_horas, costo, observaciones) SELECT p0::VARCHAR, p1::INTEGER, p2::VARCHAR, p3::TIMESTAMP WITHOUT TIME  ... 1529 characters truncated ... p8, p9, p10, sen_counter) ORDER BY sen_counter RETURNING mantenimiento.id, mantenimiento.id AS id__1]
[parameters: {'equipo_id__0': None, 'tecnico_id__0': 38, 'tiempo_ejecucion_horas__0': None, 'observaciones__0': 'Mantenimiento exitoso, sistema operando normalmente', 'costo__0': None, 'tipo__0': None, 'materiales_utilizados__0': None, 'equipo_tipo__0': 'Camara', 'descripcion__0': None, 'equipos_afectados__0': None, 'fecha__0': datetime.datetime(2025, 10, 22, 5, 39, 48, 110861), 'equipo_id__1': None, 'tecnico_id__1': 38, 'tiempo_ejecucion_horas__1': None, 'observaciones__1': 'Mantenimiento trimestral programado', 'costo__1': None, 'tipo__1': 'Preventivo', 'materiales_utilizados__1': None, 'equipo_tipo__1': 'Camara', 'descripcion__1': None, 'equipos_afectados__1': None, 'fecha__1': datetime.datetime(2025, 10, 22, 5, 39, 48, 119683), 'equipo_id__2': None, 'tecnico_id__2': 38, 'tiempo_ejecucion_horas__2': None, 'observaciones__2': 'Switch presentaba sobrecalentamiento', 'costo__2': None, 'tipo__2': 'Correctivo', 'materiales_utilizados__2': None, 'equipo_tipo__2': 'Camara', 'descripcion__2': None, 'equipos_afectados__2': None, 'fecha__2': datetime.datetime(2025, 10, 22, 5, 39, 48, 119825), 'equipo_id__3': None, 'tecnico_id__3': 38, 'tiempo_ejecucion_horas__3': None, 'observaciones__3': 'RAID 1 operando correctamente', 'costo__3': None, 'tipo__3': 'Preventivo', 'materiales_utilizados__3': None, 'equipo_tipo__3': 'Camara', 'descripcion__3': None, 'equipos_afectados__3': None, 'fecha__3': datetime.datetime(2025, 10, 22, 5, 39, 48, 119946), 'equipo_id__4': None, 'tecnico_id__4': 38, 'tiempo_ejecucion_horas__4': None, 'observaciones__4': 'Fuente presentó falla total - reemplazada', 'costo__4': None, 'tipo__4': 'Correctivo', 'materiales_utilizados__4': None, 'equipo_tipo__4': 'Camara', 'descripcion__4': None, 'equipos_afectados__4': None, 'fecha__4': datetime.datetime(2025, 10, 22, 5, 39, 48, 120060), 'equipo_id__5': None, 'tecnico_id__5': 38, 'tiempo_ejecucion_horas__5': None, 'observaciones__5': 'Baterías con 1 año de uso - cambio preventivo', 'costo__5': None, 'tipo__5': 'Preventivo', 'materiales_utilizados__5': None, 'equipo_tipo__5': 'Camara', 'descripcion__5': None, 'equipos_afectados__5': None, 'fecha__5': datetime.datetime(2025, 10, 22, 5, 39, 48, 120194)}]
(Background on this error at: https://sqlalche.me/e/20/gkpj) (Background on this error at: https://sqlalche.me/e/20/7s2a)
